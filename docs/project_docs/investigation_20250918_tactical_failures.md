# Tactical Failures Investigation Plan (2025-09-18)

## Context
- **Branch**: `investigation/20250918-tactical-failures`
- **Source data**: `tools/tactical_failures_2025-09-18_20-28-06.csv` generated by `tools/run_wac_test.sh`
- **Baseline analysis**: Manual review + scripted SAN classification (2025-09-19) highlighting systematic avoidance of forcing continuations.

## Observed Symptoms
- Engine repeatedly selects quiet/defensive moves instead of decisive forcing continuations that deliver check or capture.
- Sacrificial attacks on the castled king (especially `Qxh7+` / `Qxg7+`) are consistently rejected in favour of slow queen moves (`Qh5`, `Qh6`, `f4`).
- Knight check tactics (e.g., `Nxa7+`, `Ne7+`, `Nh6+`) are ignored in favour of repositioning moves.
- Back-rank exploitation opportunities (`Re8+`, `Rh8+`, `Rc1+`) are declined; the engine chooses consolidation (`Re1`, `Rc5+`).
- Pressure on the f6/g7 complex is undervalued; forcing bishop/knight hits are replaced with quiet pawn or queen moves.

## Data Highlights
| Metric | Expected | Engine |
| --- | --- | --- |
| Forcing moves (check/capture) | 29 checks / 29 captures | 6 checks / 7 captures |
| Total positions | \>= 54 | \>= 54 |
| Queen sac vs. castled king | 6 occurrences | 0 executions |
| Knight check shots | 5 occurrences | 0 executions |
| Back-rank rook entries | 3 occurrences | 0 executions |
| Forcing→quiet substitutions | 34 cases | — |

### Current Classification Snapshot (2025-09-18)
- **Solved outright**: 12/54 (correct move becomes best choice at one of 100/850/2000 ms).
- **Surfaced in PV only**: 15/54 (correct move observed in a PV line but never selected).
- **Never surfaced**: 27/54 (correct move absent from bestmove *and* all PVs even at 2000 ms). Dominant motifs: 8 queen sacs on h/g files, 6 rook mating nets, 5 other king-attack forcing lines.

Representative examples (from CSV `position_id`):
- **Queen sac**: `WAC.014`, `WAC.049`, `WAC.055`, `WAC.207`, `WAC.212`, `WAC.245`
- **Knight checks**: `WAC.071`, `WAC.157`, `WAC.194`, `WAC.288`, `WAC.290`
- **Back-rank entries**: `WAC.237`, `WAC.250`, `WAC.282`
- **f6 pressure**: `WAC.183`, `WAC.200`, `WAC.222`, `WAC.288`

## Working Hypotheses
1. **Search pruning bias**: Aggressive pruning/reduction (e.g., null-move, LMR) may cut decisive forcing continuations before they surface.
2. **Evaluation undervalues king exposure**: Piece-square / king attack terms may be too timid, making sacrificial attacks look unsound.
3. **Move ordering suppresses forcing moves**: Killer/history heuristics could be prioritising quiet/defensive replies, causing forcing moves to appear late and suffer pruning/reductions.
4. **Quiescence coverage gaps**: Tactical captures/checks on the horizon may be outside quiescence scope, so the root eval sees quiet positions only.
5. **LMR re-search thresholds**: Forcing moves tagged as "late" could be heavily reduced and never re-searched to full depth.

## Investigation Tracks
### Track A – Search Diagnostics
- Instrument search to log pruning/reduction decisions when a known failing move is rejected.
- Re-run `tools/run_wac_test.sh` with tracing enabled for sample IDs (e.g., `WAC.014`, `WAC.207`, `WAC.288`).
- Capture statistics: R cutoff reasons (null move, futility, LMR depth) for expected moves vs. chosen move.

### Track B – Evaluation Review
- Audit king-safety components: attacker weights, shelter penalties, open-file bonuses.
- Compare eval before/after expected move: is sacrifice scored negatively despite material investment?
- Run static eval diff tooling on positions with `expect vs. engine` to see scoring delta contributions.

### Track C – Move Ordering & Heuristics
- Inspect ordering features (history, killers, counter-move tables) to see whether forcing moves lack bonuses.
- Experiment: temporarily boost history score for checks/captures and rerun WAC subset to gauge sensitivity.

### Track D – Focused Testing
- Build WAC subset suites grouped by motif (queen sacs, knight checks, back-rank hits, f6 probes).
- Run short-depth vs. high-depth searches to see whether failures disappear with depth (horizon test).
- For successful replays, record depth, nodes, and move-ordering stats.

### Initial Tooling (2025-09-18)
- `tests/positions/wac_failures_20250918.epd` – subset of 54 failing WAC positions for rapid iteration.
- `tools/tactical_investigation.py` – targeted harness to probe selected IDs at multiple time controls, logging whether the expected move appears as bestmove or inside any PV.
- `tools/run_tactical_investigation.sh` – convenience wrapper mirroring `run_wac_test.sh` defaults.
- `DebugTrackedMoves` UCI option – trace specific UCI moves (e.g., `h3h7`) during search; outputs detailed `info string DebugMove …` diagnostics saved under `docs/project_docs/telemetry/tactical/`.
- `KingAttackScale` UCI option – scales the offensive king-safety component (0 = default scoring). Example: `setoption name KingAttackScale value 200` triples the effect.

**How to Reproduce Current Telemetry**
- Baseline split (solved / PV-only / never-surfaced):
  ```bash
  python3 tools/tactical_investigation.py \
      --engine bin/seajay \
      --ids-from-csv tools/tactical_failures_2025-09-18_20-28-06.csv \
      --time-ms 100 850 2000 \
      --output tools/tactical_investigation_2025-09-18_20-51-44.csv
  ```
- SearchStats telemetry for queen sacs:
  ```bash
  python3 - <<'PY'
  import subprocess, textwrap
  cases = [
      ("WAC.014", "r2rb1k1/pp1q1p1p/2n1p1p1/2bp4/5P2/PP1BPR1Q/1BPN2PP/R5K1 w - - 0 1"),
      ("WAC.207", "r1bq2kr/p1pp1ppp/1pn1p3/4P3/2Pb2Q1/BR6/P4PPP/3K1BNR w - - 0 1"),
  ]
  movetimes = [100, 850, 2000]
  for pid, fen in cases:
      for mt in movetimes:
          cmd = f"""uci\nsetoption name SearchStats value true\nposition fen {fen}\ngo movetime {mt}\nquit\n"""
          out = subprocess.run(['bin/seajay'], input=cmd, text=True, capture_output=True).stdout
          open(f"docs/project_docs/telemetry/tactical/{pid}_mt{mt}_searchstats.txt", 'w').write(out)
  PY
  ```
- Move-level tracing with eval/cutoff markers (DebugTrackedMoves):
  ```bash
  python3 - <<'PY'
  import subprocess, textwrap
  cases = [
      ("WAC.014", "h3h7", "r2rb1k1/pp1q1p1p/2n1p1p1/2bp4/5P2/PP1BPR1Q/1BPN2PP/R5K1 w - - 0 1"),
      ("WAC.207", "g4g7", "r1bq2kr/p1pp1ppp/1pn1p3/4P3/2Pb2Q1/BR6/P4PPP/3K1BNR w - - 0 1"),
  ]
  movetimes = [100, 850, 2000]
  for pid, move, fen in cases:
      for mt in movetimes:
          cmd = f"""uci\nsetoption name DebugTrackedMoves value {move}\nsetoption name SearchStats value true\nposition fen {fen}\ngo movetime {mt}\nquit\n"""
          out = subprocess.run(['bin/seajay'], input=cmd, text=True, capture_output=True).stdout
          open(f"docs/project_docs/telemetry/tactical/{pid}_mt{mt}_tracked.txt", 'w').write(out)
  PY
  ```

## Immediate Action Items
1. **Create motif-tagged mini suites** derived from the CSV for quick repro (scripts TBD).
2. **Add search instrumentation flag** to dump pruning reasons for a given FEN + PV.
3. **Benchmark sensitivity**: adjust king-attack evaluation weight in sandbox branch; verify if `Qxh7+` becomes preferred.
4. **Document findings** after each experiment in this branch; append results to a running log section below.

## Logging Template (Append Experiments Here)
```
### Experiment <ID>
- Positions: [...]
- Change: <search/eval tweak>
- Result: <engine move vs. expected, score deltas>
- Notes: <pruning logs, eval terms, anomalies>
```

### Experiment 2025-09-18A
- Positions: 54 tactical failures from `tools/tactical_failures_2025-09-18_20-28-06.csv`
- Change: Baseline measurement with new harness (`100`, `850`, `2000` ms per move)
- Result: 12 positions solved (best move selected), 15 positions show the correct move in PV but never selected, 27 positions never surface the correct move or PV reference; CSV log at `tools/tactical_investigation_2025-09-18_20-51-44.csv`
- Notes: "Never-found" set dominated by queen sacrifices (`Qxh7+/Qxg7+`) and rook mating nets; PV-only set often finds the move briefly at low depth before pivoting away (likely pruning/ordering interaction)

### Experiment 2025-09-18B
- Positions: `WAC.014` (`Qxh7+` sac) and `WAC.207` (`Qxg7+` sac)
- Change: Enabled `SearchStats` telemetry; `go movetime` at 100/850/2000 ms and captured raw UCI streams (`docs/project_docs/telemetry/tactical/WAC.014_mt{100,850,2000}_searchstats.txt`, `docs/project_docs/telemetry/tactical/WAC.207_mt{100,850,2000}_searchstats.txt`)
- Result: Neither position ever exposes the sacrifice inside PVs. Logs show extremely heavy futility and null pruning (e.g., `WAC.014` at 2000 ms: futility 1.58 M, null 192 k attempts with 27.7% cut rate) stabilising around the quiet move `b3b4`; `WAC.207` shows persistent negative evals with repeated `f2f4/g1f3` PVs and similar null/futility pressure.
- Notes: Suggests sacrificial lines are either ranked late (so LMR/futility collapse them) or immediately fail static bounds, preventing them from entering PV chaining.

### Experiment 2025-09-18C
- Positions: `WAC.120` (PV-only case) and `WAC.212` (PV-only queen sac)
- Change: Depth sweep (`go depth 4…12`) recording first PV move
- Result: `WAC.120` flips from tactical material grab (`Bxf6`) at depth ≤6 to defensive rook moves (`Re1/Rg1`) from depth ≥7; expected `Rhg1` never reappears. `WAC.212` briefly considers `Bxe5` at depth 4 before freezing on `Rh8-h5` from depth 5 onward, with `Qxg7+` never promoted.
- Notes: Both cases indicate the expected move may appear during shallow expansion but is discarded as deeper reductions/ordering amplify alternative quiet responses.

### Experiment 2025-09-18D
- Positions: `WAC.014` (`Qxh7+`) and `WAC.207` (`Qxg7+`)
- Change: New `DebugTrackedMoves` telemetry across `movetime {100, 850, 2000}`; logs in `docs/project_docs/telemetry/tactical/WAC.{014,207}_mt*_tracked.txt`
- Result (WAC.014): Move is generated at every iteration; only pruning observed is a single move-count prune when ranked 8th at depth 3. Scores hover between -10 cp and +30 cp and drift negative beyond depth 6, so `b3b4` remains preferred despite the sac being searched. (WAC.207): No pruning, but repeated fail-high cutoffs (scores ≈ 31990) collapse to −280 cp after the full-window re-search, indicating defensive resources appear once the search widens.
- Notes: Both lines reach the search but evaluation/ordering suppress them—queen sacs arrive late (susceptible to LMP) and never gain enough score, while `Qxg7+` looks winning in reduced windows yet fails under the full search, pointing to evaluation depth rather than generation issues.

### Experiment 2025-09-18E
- Positions: Same as D
- Change: Global `KingAttackScale` boost (`setoption … value 200`) to force large king-attack bonuses
- Result: Depth-12 search finally chooses `Qxh7+` (mate 5), but OpenBench SPRT vs. integration baseline shows −68.6 ±18.6 Elo (10+0.1 TC, 816 games). Global evaluation tweak breaks more than it fixes.
- Notes: Confirms evaluation knobs alone aren’t a safe solution. Next steps focus on search selectivity (e.g., LMP/LMR adjustments) to keep forcing checks alive without inflating every attack.

## Risks & Open Questions
- Forcing adjustments may destabilise search/selectivity trade-offs; need regression monitoring.
- Potential interaction with recent depth/speed optimisations on parent integration branch.
- Do these failures reproduce under deeper search or alternative time controls?

## References
- CSV dataset: `tools/tactical_failures_2025-09-18_20-28-06.csv`
- Generation script: `tools/run_wac_test.sh`
- Related tactical history: `tools/tactical_test_history.csv`
- Prior branch context: `integration/20250912-depth-and-search-speed`
- **KingAttackScale sensitivity (WAC.014)**
  ```bash
  uci
  setoption name KingAttackScale value 200
  position fen r2rb1k1/pp1q1p1p/2n1p1p1/2bp4/5P2/PP1BPR1Q/1BPN2PP/R5K1 w - - 0 1
  go depth 12
  ```
  With scale ≥200 the engine now selects `Qxh7+`; at scale 0 it still prefers `b3b4`. This confirms the sac is evaluation-bound rather than a legality issue.
