# Tactical Failures Investigation Plan (2025-09-18)

## Context
- **Branch**: `investigation/20250918-tactical-failures`
- **Source data**: `tools/tactical_failures_2025-09-18_20-28-06.csv` generated by `tools/run_wac_test.sh`
- **Baseline analysis**: Manual review + scripted SAN classification (2025-09-19) highlighting systematic avoidance of forcing continuations.

## Observed Symptoms
- Engine repeatedly selects quiet/defensive moves instead of decisive forcing continuations that deliver check or capture.
- Sacrificial attacks on the castled king (especially `Qxh7+` / `Qxg7+`) are consistently rejected in favour of slow queen moves (`Qh5`, `Qh6`, `f4`).
- Knight check tactics (e.g., `Nxa7+`, `Ne7+`, `Nh6+`) are ignored in favour of repositioning moves.
- Back-rank exploitation opportunities (`Re8+`, `Rh8+`, `Rc1+`) are declined; the engine chooses consolidation (`Re1`, `Rc5+`).
- Pressure on the f6/g7 complex is undervalued; forcing bishop/knight hits are replaced with quiet pawn or queen moves.

## Data Highlights
| Metric | Expected | Engine |
| --- | --- | --- |
| Forcing moves (check/capture) | 29 checks / 29 captures | 6 checks / 7 captures |
| Total positions | \>= 54 | \>= 54 |
| Queen sac vs. castled king | 6 occurrences | 0 executions |
| Knight check shots | 5 occurrences | 0 executions |
| Back-rank rook entries | 3 occurrences | 0 executions |
| Forcing→quiet substitutions | 34 cases | — |

Representative examples (from CSV `position_id`):
- **Queen sac**: `WAC.014`, `WAC.049`, `WAC.055`, `WAC.207`, `WAC.212`, `WAC.245`
- **Knight checks**: `WAC.071`, `WAC.157`, `WAC.194`, `WAC.288`, `WAC.290`
- **Back-rank entries**: `WAC.237`, `WAC.250`, `WAC.282`
- **f6 pressure**: `WAC.183`, `WAC.200`, `WAC.222`, `WAC.288`

## Working Hypotheses
1. **Search pruning bias**: Aggressive pruning/reduction (e.g., null-move, LMR) may cut decisive forcing continuations before they surface.
2. **Evaluation undervalues king exposure**: Piece-square / king attack terms may be too timid, making sacrificial attacks look unsound.
3. **Move ordering suppresses forcing moves**: Killer/history heuristics could be prioritising quiet/defensive replies, causing forcing moves to appear late and suffer pruning/reductions.
4. **Quiescence coverage gaps**: Tactical captures/checks on the horizon may be outside quiescence scope, so the root eval sees quiet positions only.
5. **LMR re-search thresholds**: Forcing moves tagged as "late" could be heavily reduced and never re-searched to full depth.

## Investigation Tracks
### Track A – Search Diagnostics
- Instrument search to log pruning/reduction decisions when a known failing move is rejected.
- Re-run `tools/run_wac_test.sh` with tracing enabled for sample IDs (e.g., `WAC.014`, `WAC.207`, `WAC.288`).
- Capture statistics: R cutoff reasons (null move, futility, LMR depth) for expected moves vs. chosen move.

### Track B – Evaluation Review
- Audit king-safety components: attacker weights, shelter penalties, open-file bonuses.
- Compare eval before/after expected move: is sacrifice scored negatively despite material investment?
- Run static eval diff tooling on positions with `expect vs. engine` to see scoring delta contributions.

### Track C – Move Ordering & Heuristics
- Inspect ordering features (history, killers, counter-move tables) to see whether forcing moves lack bonuses.
- Experiment: temporarily boost history score for checks/captures and rerun WAC subset to gauge sensitivity.

### Track D – Focused Testing
- Build WAC subset suites grouped by motif (queen sacs, knight checks, back-rank hits, f6 probes).
- Run short-depth vs. high-depth searches to see whether failures disappear with depth (horizon test).
- For successful replays, record depth, nodes, and move-ordering stats.

### Initial Tooling (2025-09-18)
- `tests/positions/wac_failures_20250918.epd` – subset of 54 failing WAC positions for rapid iteration.
- `tools/tactical_investigation.py` – targeted harness to probe selected IDs at multiple time controls, logging whether the expected move appears as bestmove or inside any PV.
- `tools/run_tactical_investigation.sh` – convenience wrapper mirroring `run_wac_test.sh` defaults.

## Immediate Action Items
1. **Create motif-tagged mini suites** derived from the CSV for quick repro (scripts TBD).
2. **Add search instrumentation flag** to dump pruning reasons for a given FEN + PV.
3. **Benchmark sensitivity**: adjust king-attack evaluation weight in sandbox branch; verify if `Qxh7+` becomes preferred.
4. **Document findings** after each experiment in this branch; append results to a running log section below.

## Logging Template (Append Experiments Here)
```
### Experiment <ID>
- Positions: [...]
- Change: <search/eval tweak>
- Result: <engine move vs. expected, score deltas>
- Notes: <pruning logs, eval terms, anomalies>
```

## Risks & Open Questions
- Forcing adjustments may destabilise search/selectivity trade-offs; need regression monitoring.
- Potential interaction with recent depth/speed optimisations on parent integration branch.
- Do these failures reproduce under deeper search or alternative time controls?

## References
- CSV dataset: `tools/tactical_failures_2025-09-18_20-28-06.csv`
- Generation script: `tools/run_wac_test.sh`
- Related tactical history: `tools/tactical_test_history.csv`
- Prior branch context: `integration/20250912-depth-and-search-speed`
