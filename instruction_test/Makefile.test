# Test Makefile for auto-detecting CPU capabilities

CXX ?= g++
EXE = test_auto

# Auto-detect CPU capabilities
ARCH_FLAGS := -march=native

# Base optimization flags
BASE_FLAGS := -O3 -DNDEBUG

# Combine flags
CXXFLAGS := $(BASE_FLAGS) $(ARCH_FLAGS)

# Optional: Add link-time optimization if available
LTO_FLAGS := -flto

.PHONY: all info clean

all: info
	$(CXX) $(CXXFLAGS) instruction_test.cpp -o $(EXE)
	@echo ""
	@echo "Running test binary:"
	@echo "--------------------"
	./$(EXE)

info:
	@echo "Testing CPU capability auto-detection"
	@echo "======================================"
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo ""
	@echo "Detected capabilities:"
	@$(CXX) -march=native -dM -E - < /dev/null | grep -E "SSE|AVX|BMI|POPCNT" | sort | sed 's/#define __/  /;s/__ 1//'
	@echo ""

with-lto:
	$(CXX) $(CXXFLAGS) $(LTO_FLAGS) instruction_test.cpp -o $(EXE)_lto
	@echo "Built with LTO"
	./$(EXE)_lto

clean:
	rm -f $(EXE) $(EXE)_lto